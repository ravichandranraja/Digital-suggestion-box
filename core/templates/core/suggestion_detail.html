{% extends 'core/base.html' %}

{% block title %}{{ suggestion.title }} - Digital Suggestion Box{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'dashboard' %}" class="text-primary hover:text-blue-600 flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <!-- Suggestion Details -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-8">
        <div class="flex items-start justify-between mb-6">
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ suggestion.title }}</h1>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span>Category: {{ suggestion.category.name }}</span>
                    <span>Submitted: {{ suggestion.created_at|date:"M d, Y" }}</span>
                    {% if suggestion.is_anonymous %}
                        <span class="text-gray-400">Anonymous</span>
                    {% else %}
                        <span>By: {{ suggestion.user.username }}</span>
                    {% endif %}
                </div>
            </div>
            <span id="status-badge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                {% if suggestion.status == 'under_review' %}bg-yellow-100 text-yellow-800
                {% elif suggestion.status == 'accepted' %} bg-green-100 text-green-800
                {% else %}bg-red-100 text-red-800{% endif %}">
                {{ suggestion.get_status_display }}
            </span>
            {% if can_manage %}
            <form id="status-update-form" class="ml-4 flex items-center" method="post" onsubmit="return false;">
                <select id="status-select" name="status" class="border rounded px-2 py-1 text-sm mr-2">
                    <option value="under_review" {% if suggestion.status == 'under_review' %}selected{% endif %}>Under Review</option>
                    <option value="accepted" {% if suggestion.status == 'accepted' %}selected{% endif %}>Accepted</option>
                    <option value="rejected" {% if suggestion.status == 'rejected' %}selected{% endif %}>Rejected</option>
                </select>
                <button type="submit" class="bg-primary hover:bg-blue-600 text-white font-medium py-1 px-4 rounded transition duration-200 text-sm">Update</button>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('status-update-form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const status = document.getElementById('status-select').value;
                            fetch("{% url 'update_suggestion_status' suggestion.id %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': '{{ csrf_token }}',
                                },
                                body: `status=${status}`
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    window.location.reload();
                                } else {
                                    alert('Failed to update status: ' + (data.error || 'Unknown error'));
                                }
                            })
                            .catch(() => alert('Failed to update status.'));
                        });
                    }
                });
            </script>
            {% endif %}
        </div>

        <div class="prose max-w-none">
            <p class="text-gray-700 leading-relaxed">{{ suggestion.content|linebreaks }}</p>
        </div>
    </div>

    <!-- Replies Section -->
    <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Replies</h2>
        
        {% if suggestion.replies.all %}
            <div class="space-y-6">
                {% for reply in suggestion.replies.all %}
                <div class="border-l-4 border-primary pl-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-medium text-gray-900">
                                {% if reply.admin %}
                                    {{ reply.admin.username }} (Admin)
                                {% else %}
                                    Admin
                                {% endif %}
                            </span>
                            <span class="text-sm text-gray-500">{{ reply.created_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                    <p class="text-gray-700">{{ reply.content|linebreaks }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No replies yet</h3>
                <p class="mt-1 text-sm text-gray-500">
                    {% if user.is_staff %}
                        Be the first to reply to this suggestion.
                    {% else %}
                        No admin responses yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}

        <!-- Reply Form (Admin Only) -->
        {% if can_manage %}
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add Reply</h3>
                <form method="post" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label for="{{ reply_form.content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Your Response
                        </label>
                        {{ reply_form.content }}
                        {% if reply_form.content.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ reply_form.content.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-md transition duration-200">
                            Send Reply
                        </button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %} 